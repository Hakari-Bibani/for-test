// JavaScript code for the titration simulation

// Constants
const BURETTE_HEIGHT = 200;
const FLASK_VOLUME = 50;
const EQUIVALENCE_POINT = 25;
const INDICATOR_pH_CHANGE = 8.2;

// DOM elements
const burette = document.getElementById('burette');
const flaskSolution = document.getElementById('flask-solution');
const indicator = document.getElementById('indicator');

// Titration variables
let currentVolume = 0;
let isExperimentRunning = false;

function startExperiment() {
  if (isExperimentRunning) return;
  isExperimentRunning = true;

  // Animation loop
  function animate() {
    if (currentVolume < EQUIVALENCE_POINT) {
      // Add NaOH drop
      addNaOHDrop();

      // Update burette level
      burette.style.height = `${BURETTE_HEIGHT * (1 - currentVolume / FLASK_VOLUME)}px`;

      // Update flask solution color
      const pH = calculatePH(currentVolume);
      updateFlaskColor(pH);

      requestAnimationFrame(animate);
    } else {
      // Titration complete
      isExperimentRunning = false;
      updateFlaskColor(INDICATOR_pH_CHANGE);
    }
  }

  animate();
}

function addNaOHDrop() {
  // Create a new drop element
  const drop = document.createElement('div');
  drop.classList.add('drop');
  drop.style.left = `${Math.random() * 80 + 10}%`;
  flaskSolution.appendChild(drop);

  // Animate the drop
  drop.animate([
    { transform: 'translateY(-100%)' },
    { transform: 'translateY(100%)' }
  ], {
    duration: 1000,
    fill: 'forwards'
  });

  // Remove the drop after the animation is complete
  setTimeout(() => {
    flaskSolution.removeChild(drop);
  }, 1000);

  // Update the volume
  currentVolume += 1;
}

function calculatePH(volume) {
  if (volume < EQUIVALENCE_POINT) {
    return -Math.log10(Math.abs(0.1 - (0.1 * volume / EQUIVALENCE_POINT)));
  } else if (Math.abs(volume - EQUIVALENCE_POINT) < 0.1) {
    return 7;
  } else {
    return 14 + Math.log10(Math.abs((0.1 * (volume - EQUIVALENCE_POINT)) / volume));
  }
}

function updateFlaskColor(pH) {
  if (pH < INDICATOR_pH_CHANGE) {
    flaskSolution.style.backgroundColor = '#e6f3ff';
    indicator.style.backgroundColor = 'transparent';
  } else {
    flaskSolution.style.backgroundColor = '#ffcce6';
    indicator.style.backgroundColor = '#ffcce6';
  }
}
